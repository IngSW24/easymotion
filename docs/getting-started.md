# How to Develop on EasyMotion

This repository is a monorepo managed with **pnpm**. It contains both the **api** and **webapp** projects for EasyMotion, as well as shared packages for automatic API client generation, authentication wrappers, and ESLint configurations.

## Table of Contents

- [Getting Started](#getting-started)
  - [Define Domain in /etc/hosts](#define-domain-in-etchosts)
  - [Install pnpm](#install-pnpm)
  - [Install Docker](#install-docker)
  - [Clone the Repository](#clone-the-repository)
  - [Set Up the Dev Environment](#set-up-the-dev-environment)
  - [HTTPS and Certificates](#https-and-certificates)
- [Autogenerated Clients](#about-the-autogenerated-clients)
- [Useful Commands](#useful-commands)
- [DevContainers Support](#devcontainers-support)

## Getting Started

### Define Domain in /etc/hosts

To use HTTPS during local development, we rely on a fake domain: `easymotion.devlocal`. You must edit your `/etc/hosts` file and add the following entries at the bottom:

```text
127.0.0.1 easymotion.devlocal
127.0.0.1 api.easymotion.devlocal
127.0.0.1 mail.easymotion.devlocal
```

- **MacOS/Linux:** `/etc/hosts`
- **Windows:** `C:\Windows\System32\Drivers\etc\hosts`

> **Note:** Edit the file as an administrator. On Windows, open Notepad as administrator. On MacOS/Linux, run `sudo nano /etc/hosts`.

### Install pnpm

This repository uses **pnpm workspaces**. Install pnpm globally:

```bash
npm i -g pnpm
```

See other installation methods in the [pnpm documentation](https://pnpm.io/installation).

### Install Docker

Follow the [official Docker installation guide](https://docs.docker.com/engine/install/).

### Clone the Repository

```bash
git clone https://github.com/ingsw24/easymotion  # https
git clone git@github.com:IngSW24/easymotion.git  # ssh
```

### Set Up the Dev Environment

1. **Generate .env files with default variables:**

   ```bash
   pnpm env:bootstrap
   ```

   - If this fails on Windows, manually copy `webapp/.env.example` to `webapp/.env` and `api/.env.example` to `api/.env`.

2. **Install dependencies:**

   ```bash
   pnpm install
   ```

3. **Start development services (db, nginx, mailhog):**

   ```bash
   docker compose up
   # or
   docker compose up -d
   ```

   - The first run may take a while as images are pulled.

4. **Apply database migrations:**

   ```bash
   pnpm api:migrate
   ```

5. **Seed the database:**

   ```bash
   pnpm api:seed
   ```

6. **Start the application:**

   ```bash
   pnpm all
   ```

7. **Visit:**
   - [Swagger](https://api.easymotion.devlocal/swagger)
   - [Webapp](https://easymotion.devlocal)
   - [MailHog](https://mail.easymotion.devlocal)

You can access easymotion as a **user** with the following credentials:

- **Email:**: `user@easymotion.it`
- **Password:**: `password1234`

You can access easymotion as a **physiotherapist** with the following credentials:

- **Email:**: `user@easymotion.it`
- **Password:**: `password1234`

You **cannot** access easymotion as an **admin** directly, but you can authenticate to the API using swagger using the admin login endpoint (`/auth/login/admin`) with the following admin credentials:

- **Email:**: `admin@easymotion.it`
- **Password:**: `password1234`

You will then be able to access admin restricted endpoints.

### HTTPS and Certificates

The nginx image creates unsigned development certificates in `nginx/.ssl`. These allow HTTPS development but require manual acceptance ("Advanced > Proceed to website") on `api.easymotion.devloca`, `mail.easymotion.devlocal`, and `easymotion.devlocal`. You may also need to skip validation in tools like Postman or CURL.

To use trusted certificates for development, install [mkcert](https://github.com/FiloSottile/mkcert) and run:

```bash
mkcert -install
mkcert -key-file nginx/.ssl/dev.key -cert-file nginx/.ssl/dev.crt easymotion.devlocal *.easymotion.devlocal
```

---

## About the Autogenerated Clients

There are two autogenerated clients, each serving a different purpose:

- **OpenAPI client:** Used by the frontend application to run api requests.
- **Prisma client:** Used by the API to communicate with the database.

After applying a new DB migration, the Prisma client is updated automatically. The OpenAPI client is generated from `openapi/schema.json`. Use the commands below to update the API schema and generate a client that includes recent changes.

A [husky](https://typicode.github.io/husky/) hook will remind you to update the API schema when committing API changes.

---

## Useful Commands

Below are some useful commands to help you develop, test, and maintain the project. Use them as needed throughout your workflow. For convenience, we have provided shorthand scripts for common tasks, but remember that pnpm also allows you to run project-specific commands directly. For example, you can execute a command for a specific project using `pnpm --filter project-name project-specific-command` (e.g., `pnpm --filter api start:dev` will only start the API project).

### Clean Repository

```bash
pnpm clean
```

### Restore DB State and Generate New Clients

```bash
pnpm blast
```

> **Note:** This command wipes the database, reapplies migrations, reseeds, and regenerates Prisma and OpenAPI clients. This is useful as an all-in-one command, but keep in mind you will lose additional data added to the DB.

### Run Tests

```bash
# All projects
pnpm test

# Single project
pnpm --filter webapp test
pnpm --filter api test
```

### Apply DB Migrations

```bash
pnpm api:migrate
```

### Seed the DB

```bash
pnpm api:seed
```

### Regenerate Prisma Client

> **Note:** This runs automatically when applying migrations.

```bash
pnpm api:client
```

### Regenerate Webapp Client

```bash
pnpm openapi:generate
```

> Uses the current API schema. If the client does not include new changes, ensure the API schema is up to date by running `pnpm api:schema`.

### Update OpenAPI Schema

```bash
pnpm api:schema
```

### Access psql Shell

```bash
docker compose exec db psql -U easymotion
```

### Restart a Service

```bash
docker compose restart [service-name]
```

### Check Running Services

```bash
docker compose ps
```

### Attach to Logs

```bash
docker compose logs -f [service-name]
```

### Reapply Migrations from Scratch (Erasing DB Data)

```bash
pnpm api:migrate-reset
```

### Remove Docker Volume for Postgres

```bash
docker volume rm easymotion_pgdata
```

### Rebuild Docker Images

```bash
docker compose build
```

### Shutdown the Services

```bash
pnpm services:down
```

---

## DevContainers Support

The monorepo supports DevContainers. You can attach to the development container directly from VSCode or any supported IDE and run the application from the container's shell as you would locally.

If developing inside the container, reinstall dependencies from within the devcontainer shell:

```bash
pnpm clean
pnpm install
```
