# EasyMotion

This repository contains both the **API** and **WebApp** projects for EasyMotion.

### Define domain in /etc/hosts

You must edit your /etc/hosts file adding an entry that binds the domain `easymotion.devlocal` to `127.0.0.1`.

- On MacOS and Linux, the file will be located at `/etc/hosts`
- On Windows, the file will be located at `C:\Windows\System32\Drivers\etc\hosts`

You need to add the following lines to the bottom of the file.

```
127.0.0.1 easymotion.devlocal
127.0.0.1 api.easymotion.devlocal
127.0.0.1 mail.easymotion.devlocal
```

Note that this application requires sudo/administration priviledges.

### Install pnpm

This repository uses **pnpm workspaces** for monorepo management. You can install pnpm via npm by running:

```bash
npm i -g pnpm
```

Other installation methods for pnpm are described on its [documentation](https://pnpm.io/installation).

### Clone the repository

```bash
git clone https://github.com/ingsw24/easymotion  # https
git clone git@github.com:IngSW24/easymotion.git  # ssh
```

### Spin up the dev environment

Once you have cloned the repository you need to run a few commands in order to setup the environment

- Run `pnpm env:bootstrap` to generate .env files with default variables
- Run `pnpm install` to install dependencies
- Run `pnpm services:up` to startup services (db, nginx, mailhog, ...)
- Run `pnpm api:migrate` to apply database migrations
- Run `pnpm api:seed` to seed the database
- Run `pnpm all` to start all the applications
- Visit
  - **API Swagger** at [https://api.easymotion.devlocal/swagger](https://api.easymotion.devlocal/swagger)
  - **Webapp** at [https://easymotion.devlocal](https://easymotion.devlocal)
  - **MailHog** at [https://mail.easymotion.devlocal](https://mail.easymotion.devlocal)

#### HTTPS and Certificates

The nginx image will create some unsigned development certificates inside the gitignored `nginx/.ssl` folder. These certificates will allow https development but will required to be manually accepted by clicking `Advanced > Proceed to website` on both `api.easymotion.devlocal` and `easymotion.devlocal`. You will also need to skip validation when using tools such as Postman or CURL.

In case you want to use trusted certificates for development, you can install [mkcert](https://github.com/FiloSottile/mkcert) and run

```bash
mkcert -install
mkcert -key-file nginx/.ssl/dev.key -cert-file nginx/.ssl/dev.crt easymotion.devlocal *.easymotion.devlocal
```

---

### Useful commands

#### Clean repository

```bash
pnpm clean
```

#### Run tests

```bash
# All the projects
pnpm test

# Single project
pnpm --filter webapp test
pnpm --filter api test
```

#### Apply DB migrations

```bash
pnpm api:migrate
```

#### Seed the DB

```bash
pnpm api:seed
```

#### Regenerate prisma client

> Note: this command is always executed automatically when applying migrations

```bash
pnpm api:client
```

#### Regenerate webapp client

```bash
pnpm openapi:generate
```

#### Update openapi schema

```bash
pnpm api:schema
```

#### Access psql shell

```bash
docker compose exec db psql -U easymotion
```

#### Restart a service

```bash
docker compose restart [service-name]
```

#### Check running services

```bash
docker compose ps
```

#### Attach to logs

```bash
docker compose logs -f [service-name]
```

#### Restore all autogenerated stuff 

```
pnpm blast
```

> Note: this command will wipe out the database, reapply migrations, and regenerate prisma and openapi client. It's useful when checking out branches, but use with caution.

#### Reapply migrations from scratch (erasing DB data)

```bash
pnpm api:migrate-reset
```

#### Remove docker volume for postgres

```bash
docker volume rm easymotion_pgdata
```

#### Rebuild docker images

```bash
docker compose build
```

#### Shutdown the services

```bash
pnpm services:down
```

---

## DevContainers support

The monorepo provides support for DevContainers. You can attach to the development container directly from VSCode or any other supported IDE and run the application from the container's shell as you would do for local development.

If you develop on the container, ensure to reinstall dependencies from inside the devcontainer by running the following commands inside the container's shell:

```bash
pnpm clean
pnpm install
```

---

## How to develop

- Create a new branch from the `develop` branch
- Checkout your own branch ensuring that its name follows the standard JIRA naming conventions for GitHub integrations
- Develop your feature on your branch, eventually rebasing or merging from other branches if you need to do so
- Open a Pull Request on the `develop` branch and wait for code review and approval

### Code review

| Programmer         | Reviewer           |
| ------------------ | ------------------ |
| @Nicola Revelant   | @pittis.matteo     |
| @pittis.matteo     | @Andrea Cantarutti |
| @Andrea Cantarutti | @Arghittu Thomas   |
| @Arghittu Thomas   | @Barbetti Giovanni |
| @Barbetti Giovanni | @Nicola Revelant   |

### Notes

- Branch `develop` will be aligned with the current sprint progress
- The production version will be aligned with the status of the `main` branch
